<div class="flex h-screen bg-slate-100 overflow-hidden">
    
    <!-- SIDEBAR -->
    <div class="p-4 space-y-3 bg-white border-r border-slate-200 z-50"> 
        <!-- Added bg-white and z-50 to ensure sidebar stays on top visually -->
        <p class="text-sm text-slate-400">Drag fields onto the document</p>
        
        <!-- SIGNATURE BTN -->
        <div cdkDrag (cdkDragEnded)="onDragEnded($event, 'signature')" class="w-full flex items-center p-3 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 transition text-slate-600 cursor-move shadow-sm">
            <i class="pi pi-pencil mr-2 text-blue-500"></i> Signature
            
            <!-- THE FIX: This preview element floats above everything -->
            <div *cdkDragPreview class="w-64 flex items-center p-3 rounded-lg bg-white border-2 border-blue-500 shadow-xl opacity-90 z-[9999]">
                <i class="pi pi-pencil mr-2 text-blue-500"></i> Signature
            </div>
            <div *cdkDragPlaceholder class="opacity-0"></div> 
        </div>

        <!-- INITIALS BTN -->
        <div cdkDrag (cdkDragEnded)="onDragEnded($event, 'initials')" class="w-full flex items-center p-3 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 transition text-slate-600 cursor-move shadow-sm">
            <i class="pi pi-verified mr-2 text-purple-500"></i> Initials
            
            <!-- THE FIX -->
            <div *cdkDragPreview class="w-64 flex items-center p-3 rounded-lg bg-white border-2 border-purple-500 shadow-xl opacity-90 z-[9999]">
                <i class="pi pi-verified mr-2 text-purple-500"></i> Initials
            </div>
            <div *cdkDragPlaceholder class="opacity-0"></div> 
        </div>
        
        <!-- TEXT BTN -->
        <div cdkDrag (cdkDragEnded)="onDragEnded($event, 'text')" class="w-full flex items-center p-3 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 transition text-slate-600 cursor-move shadow-sm">
            <i class="pi pi-align-left mr-2 text-green-500"></i> Text
            
            <!-- THE FIX -->
            <div *cdkDragPreview class="w-64 flex items-center p-3 rounded-lg bg-white border-2 border-green-500 shadow-xl opacity-90 z-[9999]">
                 <i class="pi pi-align-left mr-2 text-green-500"></i> Text
            </div>
            <div *cdkDragPlaceholder class="opacity-0"></div> 
        </div>
        
        <!-- DATE BTN -->
        <div cdkDrag (cdkDragEnded)="onDragEnded($event, 'date')" class="w-full flex items-center p-3 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 transition text-slate-600 cursor-move shadow-sm">
            <i class="pi pi-calendar mr-2 text-orange-500"></i> Date Signed
            
            <!-- THE FIX -->
            <div *cdkDragPreview class="w-64 flex items-center p-3 rounded-lg bg-white border-2 border-orange-500 shadow-xl opacity-90 z-[9999]">
                <i class="pi pi-calendar mr-2 text-orange-500"></i> Date Signed
            </div>
            <div *cdkDragPlaceholder class="opacity-0"></div>
        </div>
    </div>

    <!-- RIGHT CONTENT -->
    <div class="flex-1 flex flex-col h-full relative">
        
        <!-- HEADER -->
        <div class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 shadow-sm z-30">
            <span class="font-semibold text-slate-700">Preview</span>
            <div class="flex items-center space-x-2 bg-slate-100 p-1 rounded-lg">
                <button (click)="zoomOut()" class="p-2"><i class="pi pi-minus"></i></button>
                <span class="text-xs">{{ zoom }}</span>
                <button (click)="zoomIn()" class="p-2"><i class="pi pi-plus"></i></button>
            </div>
            
            <p-button label="Finish" icon="pi pi-check" styleClass="p-button-success" (onClick)="finishSigning()"></p-button>
        </div>

        <!-- MAIN CONTAINER -->
        <div #mainContainer class="flex-1 relative bg-slate-200 overflow-hidden h-full w-full">
            
            <div *ngIf="isLoading" class="absolute inset-0 z-50 flex items-center justify-center bg-slate-100 bg-opacity-90 sticky top-0 h-screen">
                <i class="pi pi-spin pi-spinner text-5xl text-blue-500"></i>
            </div>

            <ngx-extended-pdf-viewer
                *ngIf="pdfSrc"
                [src]="pdfSrc"
                [zoom]="zoom"
                [showToolbar]="false" 
                [showSidebarButton]="false"
                [showFindButton]="false"
                [showPagingButtons]="false"
                [showZoomButtons]="false"
                [showPresentationModeButton]="false"
                [showOpenFileButton]="false"
                [showPrintButton]="false"
                [showDownloadButton]="false"
                [showSecondaryToolbarButton]="false"
                [showRotateButton]="false"
                [showHandToolButton]="false"
                [showSpreadButton]="false"
                [showPropertiesButton]="false"
                [height]="'auto'"
                (pagesLoaded)="onPdfLoaded()"
                backgroundColor="#e2e8f0">
            </ngx-extended-pdf-viewer>

            <!-- PLACED FIELDS -->
            <div 
                *ngFor="let field of fields; let i = index" 
                class="absolute border-2 p-2 rounded shadow-lg flex items-center justify-center cursor-pointer z-40 group"
                [ngClass]="{
                    'bg-yellow-100 border-yellow-400 border-dashed': !field.value && field.type !== 'text', 
                    'bg-transparent border-transparent': field.value || field.type === 'text',
                    'hover:border-blue-400': field.type === 'text'
                }"
                [ngStyle]="getFieldStyle(field)"
                (click)="openSignDialog(field)"
                cdkDrag
                (cdkDragStarted)="isDragging = true" 
                (cdkDragEnded)="onDragEnded($event, field.type, field.id)"> 
                
                <!-- NOTE: Passed field.id above ðŸ‘† to enable 'Move' mode -->

                <div *ngIf="!field.value && field.type === 'signature'" class="flex items-center text-yellow-800 font-semibold">
                    <span class="text-xs bg-yellow-200 px-1 rounded mr-2">Sign</span>
                    <span class="text-sm italic text-gray-400">Sign Here</span>
                </div>

                <div *ngIf="!field.value && field.type === 'initials'" class="flex items-center text-yellow-800 font-semibold">
                    <span class="text-xs bg-yellow-200 px-1 rounded mr-2">Initials</span>
                </div>
                
                <div *ngIf="!field.value && field.type === 'date'" class="flex items-center text-yellow-800 font-semibold">
                    <span class="text-xs bg-yellow-200 px-1 rounded mr-2">Date</span>
                    <span class="text-sm italic text-gray-400">Date</span>
                </div>

                <div *ngIf="field.type === 'text'" class="w-full h-full">
                    <input 
                        type="text" 
                        [(ngModel)]="field.value" 
                        placeholder="Type text..."
                        class="w-full h-full bg-transparent border-none outline-none text-black font-sans text-lg p-1"
                        (mousedown)="$event.stopPropagation()" 
                    />
                </div>

                <div *ngIf="field.value && field.value.startsWith('data:image')" class="w-full h-full">
                    <img [src]="field.value" class="w-full h-full object-contain pointer-events-none" />
                </div>

                <div *ngIf="field.value && !field.value.startsWith('data:image') && field.type !== 'text'" class="w-full h-full flex items-center justify-center">
                    <span class="font-cursive text-3xl text-black">{{ field.value }}</span>
                </div>
                
                <button 
                    (mousedown)="$event.stopPropagation()" 
                    (click)="deleteField(i); $event.stopPropagation()"
                    class="absolute -top-3 -right-3 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center shadow hover:bg-red-600 transition z-50">
                    <i class="pi pi-times" style="font-size: 0.7rem"></i>
                </button>
            </div>

        <!-- DIALOG (Keep your existing working dialog code here) -->
        <p-dialog 
            [header]="dialogMode === 'signature' ? 'Create Signature' : 'Create Initials'" 
            [(visible)]="displaySignDialog" 
            [modal]="true" 
            [style]="{width: '600px'}" 
            [draggable]="false" 
            [resizable]="false"
            (onShow)="initSignaturePad()">
            
            <p-tabs [value]="dialogMode === 'initials' ? 'type' : 'draw'">
                
                <p-tablist>
                    <p-tab value="draw" *ngIf="dialogMode === 'signature'">Draw</p-tab>
                    <p-tab value="type">Type</p-tab>
                </p-tablist>

                <p-tabpanels>
                    
                    <p-tabpanel value="draw" *ngIf="dialogMode === 'signature'">
                        <div class="border border-slate-300 rounded bg-white mb-4 flex justify-center overflow-hidden relative">
                            <canvas 
                                #signatureCanvas 
                                class="w-full h-full cursor-crosshair touch-none" 
                                width="500" 
                                height="200"
                                style="touch-action: none;">
                            </canvas>
                        </div>
                        <div class="flex justify-between">
                            <p-button label="Clear" icon="pi pi-eraser" styleClass="p-button-text p-button-danger" (onClick)="clearPad()"></p-button>
                            <p-button label="Apply Signature" icon="pi pi-check" (onClick)="applyDrawing()"></p-button>
                        </div>
                    </p-tabpanel>

                    <p-tabpanel value="type">
                        <div class="py-8 text-center">
                            
                            <input *ngIf="dialogMode === 'signature'"
                                pInputText 
                                [(ngModel)]="typedSignature" 
                                placeholder="Type your name" 
                                class="w-full mb-6 p-3 text-2xl font-cursive text-center border-slate-300" 
                            />

                            <input *ngIf="dialogMode === 'initials'"
                                pInputText 
                                [(ngModel)]="initialsText"
                                (ngModelChange)="updateInitialsPreview()"
                                placeholder="Type full name (e.g. John Doe)" 
                                class="w-full mb-6 p-3 text-lg text-center border-slate-300" 
                            />

                            <div class="p-6 bg-slate-50 border border-slate-200 rounded mb-4">
                                <p class="text-sm text-slate-400 mb-2">Preview:</p>
                                <div class="text-4xl font-cursive text-slate-800">{{ typedSignature || 'Preview' }}</div>
                            </div>
                            <p-button label="Apply" icon="pi pi-check" (onClick)="applyTyping()" [disabled]="!typedSignature"></p-button>
                        </div>
                    </p-tabpanel>

                </p-tabpanels>
            </p-tabs>

        </p-dialog>
    </div>
</div>