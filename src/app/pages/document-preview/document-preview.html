<div class="flex h-screen bg-slate-100 overflow-hidden">
    
    <!-- LEFT SIDEBAR -->
    <div class="w-64 bg-white border-r border-slate-200 flex flex-col shadow-sm z-30">
        <div class="p-4 border-b border-slate-100">
            <h3 class="font-bold text-slate-700">Tools</h3>
        </div>
        <div class="p-4 space-y-3">
            <p class="text-sm text-slate-400">Drag fields onto the document</p>
            
            <!-- DRAGGABLE SIGNATURE BUTTON -->
            <!-- 
                cdkDrag: Makes it draggable
                [cdkDragFreeDragPosition]: Keeps it independent
                (cdkDragEnded): Calls our function when dropped
            -->
            <div 
                cdkDrag 
                (cdkDragEnded)="onDragEnded($event, 'signature')"
                class="w-full flex items-center p-3 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 transition text-slate-600 cursor-move shadow-sm z-50">
                <i class="pi pi-pencil mr-2 text-blue-500"></i> Signature
                
                <!-- This is the "Ghost" element that follows the mouse while dragging -->
                <div *cdkDragPlaceholder class="opacity-0"></div> 
            </div>
            
            <!-- DRAGGABLE DATE BUTTON -->
            <div 
                cdkDrag 
                (cdkDragEnded)="onDragEnded($event, 'date')"
                class="w-full flex items-center p-3 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 transition text-slate-600 cursor-move shadow-sm z-50">
                <i class="pi pi-calendar mr-2 text-blue-500"></i> Date Signed
                <div *cdkDragPlaceholder class="opacity-0"></div>
            </div>
        </div>
        
        <div class="mt-auto p-4">
             <p-button label="Back" icon="pi pi-arrow-left" [text]="true" (onClick)="ngOnInit()"></p-button>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="flex-1 flex flex-col h-full relative">
        
        <!-- TOOLBAR -->
        <div class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 shadow-sm z-30">
            <span class="font-semibold text-slate-700">Preview</span>
            <div class="flex items-center space-x-2 bg-slate-100 p-1 rounded-lg">
                <button (click)="zoomOut()" class="p-2"><i class="pi pi-minus"></i></button>
                <span class="text-xs">{{ zoom }}</span>
                <button (click)="zoomIn()" class="p-2"><i class="pi pi-plus"></i></button>
            </div>
            <p-button label="Finish" icon="pi pi-check" styleClass="p-button-success"></p-button>
        </div>

        <!-- PDF CONTAINER + DROPPED FIELDS LAYER -->
        <!-- We use #mainContainer to reference this div in TypeScript -->
        <div #mainContainer class="flex-1 relative bg-slate-200 overflow-y-auto h-full w-full">
            
            <!-- Loading Spinner -->
            <div *ngIf="isLoading" class="absolute inset-0 z-50 flex items-center justify-center bg-slate-100 bg-opacity-90">
                <i class="pi pi-spin pi-spinner text-5xl text-blue-500"></i>
            </div>

            <!-- 1. The PDF Viewer -->
            <ngx-extended-pdf-viewer
                *ngIf="pdfSrc"
                [src]="pdfSrc"
                [zoom]="zoom"
                [showToolbar]="false" 
                [showSidebarButton]="false"
                [showFindButton]="false"
                [showPagingButtons]="false"
                [showZoomButtons]="false"
                [showPresentationModeButton]="false"
                [showOpenFileButton]="false"
                [showPrintButton]="false"
                [showDownloadButton]="false"
                [showSecondaryToolbarButton]="false"
                [showRotateButton]="false"
                [showHandToolButton]="false"
                [showSpreadButton]="false"
                [showPropertiesButton]="false"
                [height]="'auto'"
                (pagesLoaded)="onPdfLoaded()"
                backgroundColor="#e2e8f0">
            </ngx-extended-pdf-viewer>

            <!-- 2. THE OVERLAY LAYER (Where dropped signatures appear) -->
            <!-- We loop through the 'fields' array and place them using absolute positioning -->
            <div 
                *ngFor="let field of fields; let i = index" 
                class="absolute border-2 p-2 rounded shadow-lg flex items-center justify-center cursor-pointer z-40"
                [ngClass]="{
                    'bg-yellow-100 border-yellow-400 border-dashed': !field.value, 
                    'bg-transparent border-transparent': field.value
                }"
                [style.top.px]="field.y"
                [style.left.px]="field.x"
                [style.width.px]="200"
                [style.height.px]="60"
                (click)="openSignDialog(field)"
                cdkDrag>
                
                <!-- STATE 1: Empty (Show "Sign Here") -->
                <div *ngIf="!field.value && field.type === 'signature'" class="flex items-center text-yellow-800 font-semibold">
                    <span class="text-xs bg-yellow-200 px-1 rounded mr-2">Sign</span>
                    <span class="text-sm italic text-gray-400">Sign Here</span>
                </div>

                <!-- STATE 2: Signed (Show Image) -->
                <!-- We check if the value starts with 'data:image' to know it's a drawing -->
                <div *ngIf="field.value && field.value.startsWith('data:image')" class="w-full h-full">
                    <img [src]="field.value" class="w-full h-full object-contain pointer-events-none" />
                </div>

                <!-- STATE 3: Signed (Show Typed Text) -->
                <div *ngIf="field.value && !field.value.startsWith('data:image')" class="w-full h-full flex items-center justify-center">
                    <span class="font-cursive text-2xl text-black">{{ field.value }}</span>
                </div>

                <!-- Delete Button -->
                <button 
                    (mousedown)="$event.stopPropagation()" 
                    (click)="deleteField(i); $event.stopPropagation()"
                    class="absolute -top-3 -right-3 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center shadow hover:bg-red-600 transition z-50">
                    <i class="pi pi-times" style="font-size: 0.7rem"></i>
                </button>
            </div>

        </div>

        <!-- SIGNATURE DIALOG -->
        <p-dialog 
            header="Create your signature" 
            [(visible)]="displaySignDialog" 
            [modal]="true" 
            [style]="{width: '600px'}" 
            [draggable]="false" 
            [resizable]="false"
            (onShow)="initSignaturePad()">
            
            <p-tabs>
                <!-- TAB 1: DRAW -->
                <p-tablist header="Draw">
                    <div class="border border-slate-300 rounded bg-white mb-4 flex justify-center overflow-hidden relative">
                        <!-- 
                            Standard HTML5 Canvas 
                            We give it explicit width/height styles or classes
                        -->
                        <canvas 
                            #signatureCanvas 
                            class="w-full h-full cursor-crosshair touch-none" 
                            width="500" 
                            height="200"
                            style="touch-action: none;">
                        </canvas>
                    </div>
                    <div class="flex justify-between">
                        <p-button label="Clear" icon="pi pi-eraser" styleClass="p-button-text p-button-danger" (onClick)="clearPad()"></p-button>
                        <p-button label="Apply Signature" icon="pi pi-check" (onClick)="applyDrawing()"></p-button>
                    </div>
                </p-tablist>

                <!-- TAB 2: TYPE -->
                <p-tablist header="Type">
                    <!-- (Keep existing Type logic, no changes needed here) -->
                    <div class="py-8 text-center">
                        <input pInputText [(ngModel)]="typedSignature" placeholder="Type your name" class="w-full mb-6 p-3 text-2xl font-cursive text-center border-slate-300" />
                        <div class="p-6 bg-slate-50 border border-slate-200 rounded mb-4">
                            <p class="text-sm text-slate-400 mb-2">Preview:</p>
                            <div class="text-4xl font-cursive text-slate-800">{{ typedSignature || 'Your Signature' }}</div>
                        </div>
                        <p-button label="Apply" icon="pi pi-check" (onClick)="applyTyping()" [disabled]="!typedSignature"></p-button>
                    </div>
                </p-tablist>
            </p-tabs>

        </p-dialog>
    </div>
</div>